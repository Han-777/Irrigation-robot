# 整体方案

## Main 主机 (STM32H743XIH6)

[H743教程]([【学以致用，授人以渔】2024视频教程汇总，DSP第12期，ThreadX第9期，BSP驱动第30期，USB实战第5期，GUI实战第3期（2024-04-30） - STM32F429 - 硬汉嵌入式论坛 - Powered by Discuz! (armbbs.cn)](https://www.armbbs.cn/forum.php?mod=viewthread&tid=110519))

### 反客卡发板资源

A <u>0 1 2 3 4 5</u> 6 <u>7 8 9 10</u> （带下划线为**未作为其他外设**引脚使用）

特殊引脚 A0_C  A1_C C2_C C3_C ( Direct channels are connected to analog I/Os (PA0_C, PA1_C, PC2_C and PC3_C) to optimize ADC performance.)

B <u>0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15</u> 

C <u>1 2 3 4 5 6 7</u> 8 9 10 11 12 

D 2 <u>3 4 5 6 7 11 12 13</u> 

E <u>2 3 4 5 6</u>

G <u>9 11 12 13 14</u> 

H <u>7</u> 8 9 10 11 12 13 14 

I <u>0 1 2 3</u> 4 5 6 7 8 9





【

A <u>**0 1** **2 3** **4 5**</u> **6** <u>**7** **8** **9 10**</u> （带下划线为**未作为其他外设**引脚使用）

特殊引脚 A0_C  A1_C C2_C C3_C (ADC 引脚)

B <u>**0** **1** **2 3** **4** **5 6** **7** **8 9** **10 11** **12 13** **14 15**</u> 

C <u>**1 2 3 4 5** **6 7**</u> **8 9** **10 11** **12** 

D **2** <u>**3 4 5 6 7** **11 12 13**</u> 

E <u>**2 3 4 5 6**</u>

G <u>**9** **11 12 13** **14**</u> 

H **<u>7</u> 8 9 10 11** **12** **13 14** 

I **<u>0 1 2 3</u> 4 5 6 7** **8 9**



A6: TIM13_1 | A7 TIM14_1 | A8-A11 TIM1_1-4 | 

PB 2, 3, 14, 15 | PC 1, 2, 3, 4, 5 | PD3, 4, 5, 6, 7

PG 7,9,14 \| PA8,15 \| PB5,6,7\| PE5,6 \| PC0,9 \| PD4,7

### 串口引脚

|   USART   |      外设      |          TX          |          RX           |   备注   |
| :-------: | :------------: | :------------------: | :-------------------: | :------: |
|    1_     |      蓝牙      |         PA9          |         PA10          |          |
|    2_     | TFmini激光雷达 |         PA2          |          PA3          |   left   |
|    3_     |     openmv     |   PB10 (I2C2_SCL)    |    PB11(I2C2_SDA)     |          |
|    4_     | TFmini激光雷达 | **PC10** \| H13(CAN) | **PC11** \| H14 (CAN) |  right   |
|    5_     |   mpu陀螺仪    |         PC12         |          PD2          |          |
|    6_     |                |      C6/**G14**      |       C7/**G9**       |          |
| 虚拟串口_ |    MP3语音f    |     PD6->**I8**      |     PG15->**I9**      | 需要测试 |
|     7     |                |                      |                       |          |
|     8     |                |                      |                       |          |

### CAN

| CAN  | 外设 |                TX                 |                RX                 | 备注 |
| :--: | :--: | :-------------------------------: | :-------------------------------: | :--: |
| can2 |      |         **B6**(SCL) / B13         |           **B5** / B12            |      |
| can1 |      | **B9**(I2C1_SDA) / H13 (UART4-TX) | **B8**(I2C1_SCL) / H14 (USAR4-RX) |      |

**TIM**

|      TIM       |                                                              |                                         |
| :------------: | :----------------------------------------------------------: | :-------------------------------------: |
|     TIM1_      |                        **A8(ch1) \|**                        |             **高级定时器**              |
|      TIM2      |                         **A5(ETR)**                          |                                         |
|     TIM13_     |                         **A6(ch1)**                          |            **舵机1 (pitch)**            |
|     TIM14_     |                         **A7(ch1)**                          |            **舵机2（yaw）**             |
|     TIM5_      | **A0(ch1)** \| **A1(ch2)** \| **A4(ETR)** \| **H12(CH3)** \| **I0(CH4)** |                                         |
| TIM3 （0 1 4） |     **B4(CH1)** \| B5(CH2) \| **B0(CH3)** \| **B1(CH4)**     |                                         |
|   TIM4 （7）   |        B6(CH1) \| **B7(CH2)** \| D12(CH1) \| D13(CH2)        |                                         |
|     TIM12      |                     B14(CH1) \| B15(CH2)                     | 可以引出作为PWM引脚，同时给**灰度使用** |
|      TIM3      |                     C6(CH1) \| C7 (CH2)                      |                                         |
|      TIM8      |     C6(CH1) \| C7 (CH2) \| C8(CH3) \| C9(CH4) \| I3(ETR)     |             **高级定时器**              |
|     TIM15      |                      E5(CH1) \| E6(CH2)                      |                                         |



|   外设   |                             Pin                              |          备注           |
| :------: | :----------------------------------------------------------: | :---------------------: |
|   灰度   |    PB 2, 3, 14, 15 \| PC 1, 2, 3, 4, 5 \| PD3, 4, 5, 6, 7    |                         |
|   GPIO   | D11, 12, 13 \| E2, 3, 4 \| G11, 12, 13 \| H7, 8, 9, 10, 11, 13, 14 \| I1, 2, 4, 5, 6, 7 | H13和H14可能还用作UART4 |
|  光电L   |                              I3                              |          Left           |
|  光电R   |                              I4                              |          Right          |
| 光电喷头 |                              I5                              |          喷头           |
|   IIC    |               D12(I2C4_SCL) \| D13 (I2C4_SCL)                |      还用做普通io       |
|  继电器  |                            **I6**                            |                         |
|   beep   |                              I7                              |                         |
|          |                                                              |                         |
|          |                                                              |                         |
|          |                                                              |                         |
|          |                                                              |                         |
|          |                                                              |                         |
|          |                                                              |                         |
|          |                                                              |                         |
|          |                                                              |                         |
|          |                                                              |                         |
| 继电器？ |                         PB12 \| PB4                          |        好像没有         |
|          |                                                              |                         |

![image-20240704195614283](C:\Users\blue\AppData\Roaming\Typora\typora-user-images\image-20240704195614283.png)

![image-20240704195632883](C:\Users\blue\AppData\Roaming\Typora\typora-user-images\image-20240704195632883.png)

![image-20240704195645945](C:\Users\blue\AppData\Roaming\Typora\typora-user-images\image-20240704195645945.png)

![image-20240704195706162](C:\Users\blue\AppData\Roaming\Typora\typora-user-images\image-20240704195706162.png)

![image-20240704195717271](C:\Users\blue\AppData\Roaming\Typora\typora-user-images\image-20240704195717271.png)







# 注意事项

### 1. 时间设置

HSE_STARTUP:系统启动时间改长： 5000UL

![image-20240705180852643](C:\Users\blue\AppData\Roaming\Typora\typora-user-images\image-20240705180852643.png)

# Freertos

## Heaps 堆

共享内存，在其上实现内存的分配与释放

malloc free new delete

## Stacks 栈 (the core of rtos)

the process of function call: 

* link register will store the address of function in stacks

* call the function


# CAN

### 波特率计算

$$
Baud rate = can时钟频率/(prescalar*(1+time\,segment1+time\,segment2))
$$

在配置CAN通信的波特率时，时间段1（Time Segment 1）和时间段2（Time Segment 2）的比例设置是很重要的。根据CAN协议和常见的实践，这个比例通常遵循以下原则：

1. 采样点位置：
   - 采样点通常应该位于位时间的75%到80%处。
   - 采样点 = (1 + 时间段1) / (1 + 时间段1 + 时间段2)

2. 常见比例：
   - 一个常用的比例是 (时间段1 : 时间段2) = (3 : 1) 或 (4 : 1)
   - 例如，如果总时间量程为10，可以设置时间段1为6或7，时间段2为2或3

3. 具体设置：
   - 时间段1通常设置为位时间的60%-70%
   - 时间段2通常设置为位时间的20%-30%

4. 实际例子：
   - 如果总位时间为10个时间量程（TQ），可以设置：
     同步段 = 1 TQ
     时间段1 = 6 或 7 TQ
     时间段2 = 3 或 2 TQ

5. 调整考虑：
   - 较长的时间段1提高抗干扰能力
   - 较长的时间段2提高重同步能力

6. 灵活性：
   - 这个比例可以根据具体应用和网络条件进行微调
   - 在高速CAN网络中，可能需要更精确的设置

总之，时间段1和时间段2的比例应该在保证采样点位于75%-80%的同时，尽可能地增加时间段1的长度以提高抗干扰能力。常见的比例如3:1或4:1是个很好的起点，但可以根据实际需求进行调整。

Citations:
[1] https://www.st.com.cn/zh/microcontrollers-microprocessors/stm32h7-series.html
[2] https://www.st.com.cn/zh/microcontrollers-microprocessors/stm32h7-series/products.html
[3] https://www.cnblogs.com/armfly/p/10916105.html
[4] https://www.stmcu.com.cn/stm32h7
[5] https://doc.embedfire.com/mcu/stm32/f4/hal_general/zh/latest/doc/chapter16/chapter16.html







